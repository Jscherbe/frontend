import path from "path";
import { defineConfig } from "vite";
import { getUrlDirname } from "@ulu/utils/node/path.js";
import eleventyPlugin from "../vite-plugin-eleventy/index.js";

const __dirname = getUrlDirname(import.meta.url);
const libDir = path.resolve(__dirname, "../lib/");

// https://vitejs.dev/config/
export default defineConfig(() => {
  return {
    // Make asset paths relative for deployment to subdirectories (like GitHub Pages)
    base: "./",
    // Directory for static assets that are copied directly on build
    publicDir: "site/src/static",
    server: {
      // The port for the development server
      port: 5173,
    },
    build: {
      // The output directory for built assets
      outDir: "docs",
      // Generate a manifest.json for the Eleventy plugin to map asset paths
      manifest: true,
      rollupOptions: {
        // The main entry point for the site's JavaScript
        input: "site/src/main.js",
        // The docs build was being tree-shaken incorrectly, so disable it.
        treeshake: false,
      },
    },
    resolve: {
      alias: {
        // Alias for the site source directory
        "@": __dirname,
        // Alias for the core library directory
        "@Lib": libDir,
      },
    },
    css: {
      preprocessorOptions: {
        scss: {
          // Add load paths for SCSS to allow imports from these directories
          loadPaths: [
            path.resolve(__dirname, "src/scss/"),
            libDir
          ],
          quietDeps: true,
          api: "modern-compiler",
        },
      },
    },
    plugins: [
      eleventyPlugin({
        // Path to the Eleventy configuration file
        configPath: path.resolve(__dirname, "eleventy.js"),
        // Path prefix for all URLs generated by Eleventy (for GitHub Pages)
        pathPrefix: "/frontend/",
        // The base path for Vite's dev server middleware
        publicPath: "/",
        debug: true,
      }),
    ],
  };
});